<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#16213e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∑–∞–±–æ—Ä–æ–≤</title>
  <link rel="manifest" href="manifest.json">
  <style>
:root{--bg:#1a1a2e;--bg2:#16213e;--card:#0f3460;--accent:#e94560;--text:#eee;--muted:#aaa;--border:#334155;--success:#4ade80;--warn:#fbbf24}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:60px}
.tabs{display:flex;background:var(--bg2);border-bottom:2px solid var(--border);position:sticky;top:0;z-index:100}
.tab{flex:1;padding:12px 4px;text-align:center;cursor:pointer;border:none;background:none;color:var(--muted);font-size:12px;font-weight:500}
.tab.active{color:var(--accent);border-bottom:3px solid var(--accent);margin-bottom:-2px}
.container{max-width:800px;margin:0 auto;padding:12px}
.page{display:none}.page.active{display:block}
.card{background:var(--card);border-radius:10px;padding:14px;margin-bottom:14px}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--border)}
.card-title{font-size:15px;font-weight:600;color:var(--accent)}
.form-row{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.form-group{margin-bottom:12px}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:3px}
input,select{width:100%;padding:10px;border:1px solid var(--border);border-radius:6px;background:var(--bg2);color:var(--text);font-size:14px}
input:focus,select:focus{outline:none;border-color:var(--accent)}
.btn{padding:10px 16px;border:none;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer}
.btn-primary{background:var(--accent);color:#fff}
.btn-secondary{background:var(--bg2);color:var(--text);border:1px solid var(--border)}
.btn-block{width:100%}
.btn-group{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.checkbox-label{display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer}
.checkbox-label input{width:18px;height:18px;accent-color:var(--accent)}
table{width:100%;border-collapse:collapse;font-size:12px;margin-top:10px}
th,td{padding:8px 4px;text-align:left;border-bottom:1px solid var(--border)}
th{background:var(--bg2);color:var(--muted);font-size:11px}
.text-right{text-align:right}
.totals{background:var(--bg2);border-radius:6px;padding:10px;margin-top:12px}
.total-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)}
.total-row:last-child{border-bottom:none}
.total-label{color:var(--muted);font-size:13px}
.total-value{font-weight:600}
.total-value.accent{color:var(--accent);font-size:16px}
.total-value.success{color:var(--success)}
.add-btn{width:100%;padding:12px;border:2px dashed var(--border);border-radius:8px;background:none;color:var(--muted);cursor:pointer;font-size:14px}
.add-btn:hover{border-color:var(--accent);color:var(--accent)}
.delete-btn{background:none;border:none;color:var(--accent);cursor:pointer;font-size:16px;padding:4px}
.section-title{background:var(--accent);color:#fff;padding:10px;border-radius:6px;font-size:14px;font-weight:600;margin:16px 0 10px}
.subsection-title{background:var(--bg2);padding:8px;border-radius:4px;font-size:13px;color:var(--muted);margin:10px 0 8px}
.hidden{display:none!important}
.toast{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);background:var(--card);padding:10px 20px;border-radius:6px;z-index:2000;opacity:0;transition:opacity .3s}
.toast.show{opacity:1}
.price-cat{margin-bottom:6px}
.price-cat-header{background:var(--bg2);padding:10px;border-radius:6px;cursor:pointer;display:flex;justify-content:space-between;font-size:13px;font-weight:600}
.price-items{display:none;padding:8px 0}
.price-items.open{display:block}
.price-item{display:grid;grid-template-columns:1fr 70px 70px;gap:6px;padding:6px;border-bottom:1px solid var(--border);align-items:center;font-size:12px}
.price-input{padding:6px;font-size:12px}
.side-header{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:6px;margin-bottom:10px;cursor:pointer}
.side-content{display:none}
.side-content.open{display:block}
.gate-item,.wicket-item{background:var(--bg2);border-radius:6px;padding:10px;margin-bottom:10px}
@media(max-width:500px){.form-row{grid-template-columns:1fr}.tab{font-size:11px;padding:10px 2px}}
.offline-bar{background:var(--warn);color:#000;text-align:center;padding:4px;font-size:11px;display:none}
body.offline .offline-bar{display:block}
  </style>
</head>
<body>
<div class="offline-bar">‚ö° –û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º</div>

<div class="tabs">
  <button class="tab active" data-tab="calc">–†–∞—Å—á—ë—Ç</button>
  <button class="tab" data-tab="client">–°–º–µ—Ç–∞</button>
  <button class="tab" data-tab="manager">–ú–µ–Ω–µ–¥–∂–µ—Ä</button>
  <button class="tab" data-tab="prices">–¶–µ–Ω—ã</button>
</div>

<div class="container">
  <!-- –°–¢–†–ê–ù–ò–¶–ê –†–ê–°–ß–Å–¢–ê -->
  <div id="page-calc" class="page active">
    <div class="card">
      <div class="form-group">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞</label>
        <input type="text" id="project-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∏—Å–∫–µ–ª–æ–≤–æ">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>–ö–ª–∏–µ–Ω—Ç</label>
          <input type="text" id="client-name" placeholder="–§–ò–û">
        </div>
        <div class="form-group">
          <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input type="tel" id="client-phone" placeholder="+7...">
        </div>
      </div>
      <div class="form-group">
        <label>–ê–¥—Ä–µ—Å</label>
        <input type="text" id="client-address" placeholder="–ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞">
      </div>
    </div>

    <div id="sides-container"></div>
    <button class="add-btn" id="add-side-btn">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–æ—Ä–æ–Ω—É</button>

    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ -->
    <div class="card" style="margin-top:14px">
      <div class="card-title" style="margin-bottom:10px">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</div>
      <div class="form-row">
        <div class="form-group">
          <label>–ú–∏–Ω–∏—ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä (—Å–º–µ–Ω)</label>
          <select id="excavator-shifts">
            <option value="0">–ù–µ –Ω—É–∂–µ–Ω</option>
            <option value="1">1 —Å–º–µ–Ω–∞</option>
            <option value="2">2 —Å–º–µ–Ω—ã</option>
            <option value="3">3 —Å–º–µ–Ω—ã</option>
          </select>
        </div>
        <div class="form-group">
          <label>–î–æ—Å—Ç–∞–≤–∫–∞ (—Ä–µ–π—Å–æ–≤)</label>
          <input type="number" id="delivery-trips" min="0" value="0">
        </div>
      </div>
    </div>

    <!-- –ü–ò–ö–° -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">–°—Ç–æ–ª–±—ã –ü–ò–ö–°</span>
        <button class="btn btn-secondary" onclick="addPiks()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div id="piks-container"></div>
    </div>

    <!-- –°–∫–∏–¥–∫–∞/–ù–∞—Ü–µ–Ω–∫–∞ -->
    <div class="card">
      <div class="form-row">
        <div class="form-group">
          <label>–°–∫–∏–¥–∫–∞ –∫–ª–∏–µ–Ω—Ç—É, %</label>
          <input type="number" id="discount" min="0" max="50" value="0">
        </div>
        <div class="form-group">
          <label>–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞, %</label>
          <input type="number" id="prepayment" min="0" max="100" value="33">
        </div>
      </div>
      <div class="form-group">
        <label>–ó–∞–º–µ—Ç–∫–∏</label>
        <input type="text" id="notes" placeholder="–ó–∞–º–µ—Ç–∫–∏ –ø–æ –æ–±—ä–µ–∫—Ç—É">
      </div>
    </div>

    <div class="btn-group">
      <button class="btn btn-primary btn-block" onclick="calculateAll()">üìä –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å–º–µ—Ç—É</button>
    </div>
  </div>

  <!-- –°–ú–ï–¢–ê –ö–õ–ò–ï–ù–¢–ê -->
  <div id="page-client" class="page">
    <div id="estimate-client"></div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="savePDF(false)">üìÑ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å PDF</button>
      <button class="btn btn-secondary" onclick="sharePDF()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>

  <!-- –°–ú–ï–¢–ê –ú–ï–ù–ï–î–ñ–ï–†–ê -->
  <div id="page-manager" class="page">
    <div id="estimate-manager"></div>
    <div class="btn-group">
      <button class="btn btn-primary" onclick="saveExcel()">üìä –°–æ—Ö—Ä–∞–Ω–∏—Ç—å Excel</button>
      <button class="btn btn-secondary" onclick="savePDF(true)">üìÑ PDF (–ø–æ–ª–Ω—ã–π)</button>
    </div>
  </div>

  <!-- –¶–ï–ù–´ -->
  <div id="page-prices" class="page">
    <div class="card">
      <div class="card-title" style="margin-bottom:10px">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω–∞–º–∏</div>
      <div class="btn-group">
        <button class="btn btn-secondary" onclick="exportPricesFile()">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
        <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">üìÇ –ò–º–ø–æ—Ä—Ç</button>
        <button class="btn btn-secondary" onclick="resetAllPrices()">üîÑ –°–±—Ä–æ—Å</button>
        <input type="file" id="import-file" accept=".json" style="display:none" onchange="importPricesFile(this.files[0])">
      </div>
    </div>
    <div id="prices-container"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ===== –ë–ê–ó–ê –¶–ï–ù =====
const DEFAULT_PRICES = {
  materials: {
    gitter_153_3:{name:"–°–µ—Ç–∫–∞ –ì–∏—Ç—Ç–µ—Ä 1.53–º 3–º–º",unit:"—à—Ç",buy:920,sell:1150},
    gitter_153_4:{name:"–°–µ—Ç–∫–∞ –ì–∏—Ç—Ç–µ—Ä 1.53–º 4–º–º",unit:"—à—Ç",buy:1280,sell:1430},
    gitter_153_5:{name:"–°–µ—Ç–∫–∞ –ì–∏—Ç—Ç–µ—Ä 1.53–º 5–º–º",unit:"—à—Ç",buy:1450,sell:1620},
    gitter_173_3:{name:"–°–µ—Ç–∫–∞ –ì–∏—Ç—Ç–µ—Ä 1.73–º 3–º–º",unit:"—à—Ç",buy:990,sell:1250},
    gitter_173_4:{name:"–°–µ—Ç–∫–∞ –ì–∏—Ç—Ç–µ—Ä 1.73–º 4–º–º",unit:"—à—Ç",buy:1520,sell:1790},
    gitter_173_5:{name:"–°–µ—Ç–∫–∞ –ì–∏—Ç—Ç–µ—Ä 1.73–º 5–º–º",unit:"—à—Ç",buy:1720,sell:2050},
    gitter_203_3:{name:"–°–µ—Ç–∫–∞ –ì–∏—Ç—Ç–µ—Ä 2.03–º 3–º–º",unit:"—à—Ç",buy:1130,sell:1390},
    gitter_203_4:{name:"–°–µ—Ç–∫–∞ –ì–∏—Ç—Ç–µ—Ä 2.03–º 4–º–º",unit:"—à—Ç",buy:1630,sell:1910},
    gitter_203_5:{name:"–°–µ—Ç–∫–∞ –ì–∏—Ç—Ç–µ—Ä 2.03–º 5–º–º",unit:"—à—Ç",buy:2520,sell:2995},
    proflist_035_1_16:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.35 1—Å—Ç 1.6–º",unit:"—à—Ç",buy:650,sell:800},
    proflist_035_1_18:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.35 1—Å—Ç 1.8–º",unit:"—à—Ç",buy:725,sell:850},
    proflist_035_1_20:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.35 1—Å—Ç 2.0–º",unit:"—à—Ç",buy:780,sell:900},
    proflist_035_1_22:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.35 1—Å—Ç 2.2–º",unit:"—à—Ç",buy:890,sell:1070},
    proflist_035_2_16:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.35 2—Å—Ç 1.6–º",unit:"—à—Ç",buy:685,sell:845},
    proflist_035_2_18:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.35 2—Å—Ç 1.8–º",unit:"—à—Ç",buy:760,sell:895},
    proflist_035_2_20:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.35 2—Å—Ç 2.0–º",unit:"—à—Ç",buy:815,sell:945},
    proflist_035_2_22:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.35 2—Å—Ç 2.2–º",unit:"—à—Ç",buy:925,sell:1115},
    proflist_04_1_16:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.4 1—Å—Ç 1.6–º",unit:"—à—Ç",buy:770,sell:940},
    proflist_04_1_18:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.4 1—Å—Ç 1.8–º",unit:"—à—Ç",buy:860,sell:1050},
    proflist_04_1_20:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.4 1—Å—Ç 2.0–º",unit:"—à—Ç",buy:950,sell:1190},
    proflist_04_1_22:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.4 1—Å—Ç 2.2–º",unit:"—à—Ç",buy:1110,sell:1386},
    proflist_04_2_16:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.4 2—Å—Ç 1.6–º",unit:"—à—Ç",buy:920,sell:1110},
    proflist_04_2_18:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.4 2—Å—Ç 1.8–º",unit:"—à—Ç",buy:1030,sell:1260},
    proflist_04_2_20:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.4 2—Å—Ç 2.0–º",unit:"—à—Ç",buy:1140,sell:1390},
    proflist_04_2_22:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.4 2—Å—Ç 2.2–º",unit:"—à—Ç",buy:1260,sell:1590},
    proflist_045_1_16:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.45 1—Å—Ç 1.6–º",unit:"—à—Ç",buy:920,sell:1110},
    proflist_045_1_18:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.45 1—Å—Ç 1.8–º",unit:"—à—Ç",buy:1030,sell:1270},
    proflist_045_1_20:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.45 1—Å—Ç 2.0–º",unit:"—à—Ç",buy:1140,sell:1395},
    proflist_045_1_22:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.45 1—Å—Ç 2.2–º",unit:"—à—Ç",buy:1280,sell:1610},
    proflist_045_2_16:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.45 2—Å—Ç 1.6–º",unit:"—à—Ç",buy:1130,sell:1370},
    proflist_045_2_18:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.45 2—Å—Ç 1.8–º",unit:"—à—Ç",buy:1220,sell:1490},
    proflist_045_2_20:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.45 2—Å—Ç 2.0–º",unit:"—à—Ç",buy:1320,sell:1605},
    proflist_045_2_22:{name:"–ü—Ä–æ—Ñ–ª–∏—Å—Ç 0.45 2—Å—Ç 2.2–º",unit:"—à—Ç",buy:1490,sell:1815},
    shtaketnik_15:{name:"–®—Ç–∞–∫–µ—Ç–Ω–∏–∫ 125–º–º 1.5–º",unit:"—à—Ç",buy:138,sell:178},
    shtaketnik_18:{name:"–®—Ç–∞–∫–µ—Ç–Ω–∏–∫ 125–º–º 1.8–º",unit:"—à—Ç",buy:158,sell:198},
    shtaketnik_20:{name:"–®—Ç–∞–∫–µ—Ç–Ω–∏–∫ 125–º–º 2.0–º",unit:"—à—Ç",buy:176,sell:220},
    shtaketnik_22:{name:"–®—Ç–∞–∫–µ—Ç–Ω–∏–∫ 125–º–º 2.2–º",unit:"—à—Ç",buy:194,sell:242},
    finishing_strip:{name:"–ü–ª–∞–Ω–∫–∞ —Ñ–∏–Ω–∏—à–Ω–∞—è 2–º",unit:"—à—Ç",buy:200,sell:250},
    post_60x60_2m:{name:"–°—Ç–æ–ª–± 60—Ö60 2–º",unit:"—à—Ç",buy:720,sell:890},
    post_60x60_3m:{name:"–°—Ç–æ–ª–± 60—Ö60 3–º",unit:"—à—Ç",buy:1080,sell:1330},
    cap_plastic_60:{name:"–ó–∞–≥–ª—É—à–∫–∞ 60—Ö60",unit:"—à—Ç",buy:35,sell:50},
    post_80x80_3m:{name:"–°—Ç–æ–ª–± 80—Ö80 3–º",unit:"—à—Ç",buy:2730,sell:3270},
    cap_plastic_80:{name:"–ó–∞–≥–ª—É—à–∫–∞ 80—Ö80",unit:"—à—Ç",buy:45,sell:70},
    pile_76_15:{name:"–°–≤–∞—è 76–º–º 1.5–º",unit:"—à—Ç",buy:1280,sell:1550},
    pile_76_20:{name:"–°–≤–∞—è 76–º–º 2.0–º",unit:"—à—Ç",buy:1450,sell:1750},
    pile_76_25:{name:"–°–≤–∞—è 76–º–º 2.5–º",unit:"—à—Ç",buy:1650,sell:1900},
    pile_76_30:{name:"–°–≤–∞—è 76–º–º 3.0–º",unit:"—à—Ç",buy:1850,sell:2150},
    pile_89_15:{name:"–°–≤–∞—è 89–º–º 1.5–º",unit:"—à—Ç",buy:1600,sell:1980},
    pile_89_20:{name:"–°–≤–∞—è 89–º–º 2.0–º",unit:"—à—Ç",buy:1700,sell:2150},
    pile_89_25:{name:"–°–≤–∞—è 89–º–º 2.5–º",unit:"—à—Ç",buy:1900,sell:2350},
    pile_89_30:{name:"–°–≤–∞—è 89–º–º 3.0–º",unit:"—à—Ç",buy:2200,sell:2700},
    cap_76:{name:"–û–≥–æ–ª–æ–≤–æ–∫ 76–º–º",unit:"—à—Ç",buy:320,sell:500},
    cap_89:{name:"–û–≥–æ–ª–æ–≤–æ–∫ 89–º–º —É—Å–∏–ª.",unit:"—à—Ç",buy:350,sell:600},
    lag_40x20_6m:{name:"–õ–∞–≥–∞ 40—Ö20 6–º",unit:"—à—Ç",buy:960,sell:1290},
    clamp:{name:"–•–æ–º—É—Ç –¥–ª—è –ì–∏—Ç—Ç–µ—Ä",unit:"—à—Ç",buy:55,sell:70},
    bracket:{name:"–ö—Ä–æ–Ω—à—Ç–µ–π–Ω –¥–ª—è –ª–∞–≥",unit:"—à—Ç",buy:85,sell:120},
    screw_55x19:{name:"–°–∞–º–æ—Ä–µ–∑ 5.5—Ö19",unit:"—à—Ç",buy:3,sell:4},
    gate_sliding_30:{name:"–í–æ—Ä–æ—Ç–∞ –æ—Ç–∫–∞—Ç–Ω—ã–µ 3–º",unit:"–∫–æ–º–ø–ª",buy:35000,sell:54000},
    gate_sliding_35:{name:"–í–æ—Ä–æ—Ç–∞ –æ—Ç–∫–∞—Ç–Ω—ã–µ 3.5–º",unit:"–∫–æ–º–ø–ª",buy:37000,sell:56000},
    gate_sliding_40:{name:"–í–æ—Ä–æ—Ç–∞ –æ—Ç–∫–∞—Ç–Ω—ã–µ 4–º",unit:"–∫–æ–º–ø–ª",buy:40000,sell:59000},
    gate_sliding_45:{name:"–í–æ—Ä–æ—Ç–∞ –æ—Ç–∫–∞—Ç–Ω—ã–µ 4.5–º",unit:"–∫–æ–º–ø–ª",buy:42000,sell:61000},
    gate_sliding_50:{name:"–í–æ—Ä–æ—Ç–∞ –æ—Ç–∫–∞—Ç–Ω—ã–µ 5–º",unit:"–∫–æ–º–ø–ª",buy:45000,sell:64000},
    gate_sliding_55:{name:"–í–æ—Ä–æ—Ç–∞ –æ—Ç–∫–∞—Ç–Ω—ã–µ 5.5–º",unit:"–∫–æ–º–ø–ª",buy:63000,sell:85000},
    gate_sliding_60:{name:"–í–æ—Ä–æ—Ç–∞ –æ—Ç–∫–∞—Ç–Ω—ã–µ 6–º",unit:"–∫–æ–º–ø–ª",buy:69000,sell:89000},
    foundation_sliding:{name:"–ó–∞–∫–ª–∞–¥–Ω—ã–µ –æ—Ç–∫–∞—Ç–Ω—ã—Ö",unit:"–∫–æ–º–ø–ª",buy:5500,sell:7500},
    gate_swing_30:{name:"–í–æ—Ä–æ—Ç–∞ —Ä–∞—Å–ø–∞—à–Ω—ã–µ 3–º",unit:"–∫–æ–º–ø–ª",buy:16500,sell:28000},
    gate_swing_35:{name:"–í–æ—Ä–æ—Ç–∞ —Ä–∞—Å–ø–∞—à–Ω—ã–µ 3.5–º",unit:"–∫–æ–º–ø–ª",buy:18500,sell:32000},
    gate_swing_40:{name:"–í–æ—Ä–æ—Ç–∞ —Ä–∞—Å–ø–∞—à–Ω—ã–µ 4–º",unit:"–∫–æ–º–ø–ª",buy:21000,sell:36000},
    gate_gitter_sliding_30:{name:"–í–æ—Ä–æ—Ç–∞ –æ—Ç–∫–∞—Ç. –ì–∏—Ç—Ç–µ—Ä 3–º",unit:"–∫–æ–º–ø–ª",buy:38000,sell:57000},
    gate_gitter_sliding_35:{name:"–í–æ—Ä–æ—Ç–∞ –æ—Ç–∫–∞—Ç. –ì–∏—Ç—Ç–µ—Ä 3.5–º",unit:"–∫–æ–º–ø–ª",buy:40000,sell:59000},
    gate_gitter_sliding_40:{name:"–í–æ—Ä–æ—Ç–∞ –æ—Ç–∫–∞—Ç. –ì–∏—Ç—Ç–µ—Ä 4–º",unit:"–∫–æ–º–ø–ª",buy:43000,sell:62000},
    gate_gitter_sliding_45:{name:"–í–æ—Ä–æ—Ç–∞ –æ—Ç–∫–∞—Ç. –ì–∏—Ç—Ç–µ—Ä 4.5–º",unit:"–∫–æ–º–ø–ª",buy:45000,sell:64000},
    gate_gitter_sliding_50:{name:"–í–æ—Ä–æ—Ç–∞ –æ—Ç–∫–∞—Ç. –ì–∏—Ç—Ç–µ—Ä 5–º",unit:"–∫–æ–º–ø–ª",buy:48000,sell:67000},
    gate_gitter_sliding_55:{name:"–í–æ—Ä–æ—Ç–∞ –æ—Ç–∫–∞—Ç. –ì–∏—Ç—Ç–µ—Ä 5.5–º",unit:"–∫–æ–º–ø–ª",buy:66000,sell:85000},
    gate_gitter_sliding_60:{name:"–í–æ—Ä–æ—Ç–∞ –æ—Ç–∫–∞—Ç. –ì–∏—Ç—Ç–µ—Ä 6–º",unit:"–∫–æ–º–ø–ª",buy:72000,sell:91000},
    gate_gitter_swing_30:{name:"–í–æ—Ä–æ—Ç–∞ —Ä–∞—Å–ø–∞—à. –ì–∏—Ç—Ç–µ—Ä 3–º",unit:"–∫–æ–º–ø–ª",buy:18500,sell:30500},
    gate_gitter_swing_35:{name:"–í–æ—Ä–æ—Ç–∞ —Ä–∞—Å–ø–∞—à. –ì–∏—Ç—Ç–µ—Ä 3.5–º",unit:"–∫–æ–º–ø–ª",buy:20500,sell:32500},
    gate_gitter_swing_40:{name:"–í–æ—Ä–æ—Ç–∞ —Ä–∞—Å–ø–∞—à. –ì–∏—Ç—Ç–µ—Ä 4–º",unit:"–∫–æ–º–ø–ª",buy:23000,sell:35000},
    wicket_gitter:{name:"–ö–∞–ª–∏—Ç–∫–∞ –ì–∏—Ç—Ç–µ—Ä 1–º",unit:"—à—Ç",buy:9000,sell:15700},
    wicket_standard:{name:"–ö–∞–ª–∏—Ç–∫–∞ 1–º",unit:"—à—Ç",buy:10000,sell:17900},
    wicket_builtin:{name:"–í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∫–∞–ª–∏—Ç–∫–∞",unit:"—à—Ç",buy:10000,sell:17000},
    lock_mortise:{name:"–ó–∞–º–æ–∫ –≤—Ä–µ–∑–Ω–æ–π",unit:"—à—Ç",buy:3200,sell:3950},
    came_bx608:{name:"–ü—Ä–∏–≤–æ–¥ Came BX608",unit:"–∫–æ–º–ø–ª",buy:27000,sell:34000},
    gear_rack:{name:"–ó—É–±—á–∞—Ç–∞—è —Ä–µ–π–∫–∞ 1–º",unit:"—à—Ç",buy:880,sell:1250},
    remote:{name:"–ë—Ä–µ–ª–æ–∫ –¥–æ–ø.",unit:"—à—Ç",buy:1550,sell:1950},
    photo_sensor:{name:"–§–æ—Ç–æ—ç–ª–µ–º–µ–Ω—Ç—ã –ø–∞—Ä–∞",unit:"–∫–æ–º–ø–ª",buy:1750,sell:2180},
    wires_gofra:{name:"–ü—Ä–æ–≤–æ–¥–∞+–≥–æ—Ñ—Ä–∞",unit:"–∫–æ–º–ø–ª",buy:800,sell:1000},
    lamp_signal:{name:"–õ–∞–º–ø–∞ —Å–∏–≥–Ω–∞–ª—å–Ω–∞—è",unit:"—à—Ç",buy:1420,sell:1780},
    antenna:{name:"–ê–Ω—Ç–µ–Ω–Ω–∞",unit:"—à—Ç",buy:1120,sell:1400},
    piks_yellow:{name:"–ü–ò–ö–° –ñ—ë–ª—Ç—ã–π –∫–∏—Ä–ø–∏—á",unit:"—à—Ç",buy:450,sell:540},
    piks_red:{name:"–ü–ò–ö–° –ö—Ä–∞—Å–Ω—ã–π –∫–∏—Ä–ø–∏—á",unit:"—à—Ç",buy:450,sell:540},
    piks_brown:{name:"–ü–ò–ö–° –ö–æ—Ä–∏—á–Ω–µ–≤—ã–π –∫–∏—Ä–ø–∏—á",unit:"—à—Ç",buy:450,sell:540},
    piks_graphite:{name:"–ü–ò–ö–° –ì—Ä–∞—Ñ–∏—Ç–æ–≤—ã–π –∫–∏—Ä–ø–∏—á",unit:"—à—Ç",buy:450,sell:540},
    piks_cap:{name:"–ö—Ä—ã—à–∫–∞ –ü–ò–ö–°",unit:"—à—Ç",buy:1200,sell:1400},
    piks_guide:{name:"–ù–∞–ø—Ä–∞–≤–ª—è—é—â–∞—è –ü–ò–ö–°",unit:"—à—Ç",buy:200,sell:400},
    piks_fastener:{name:"–ö—Ä–µ–ø—ë–∂ –ü–ò–ö–°",unit:"—à—Ç",buy:0.5,sell:2},
    gravel_bag:{name:"–©–µ–±–µ–Ω—å 40–∫–≥",unit:"–º–µ—à",buy:180,sell:220},
    cps_bag:{name:"–¶–ü–°-300 25–∫–≥",unit:"–º–µ—à",buy:250,sell:350},
    paint_touch:{name:"–ì—Ä—É–Ω—Ç-—ç–º–∞–ª—å 3–≤1 1–ª",unit:"—à—Ç",buy:900,sell:1500},
    consumables:{name:"–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏",unit:"–∫–æ–º–ø–ª",buy:1500,sell:2000},
    excavator:{name:"–ú–∏–Ω–∏—ç–∫—Å–∫–∞–≤–∞—Ç–æ—Ä",unit:"—Å–º–µ–Ω–∞",buy:20000,sell:25000}
  },
  works: {
    work_drilling:{name:"–ë—É—Ä–µ–Ω–∏–µ –ª—É–Ω–∫–∏",unit:"—à—Ç",crew:350,sell:750},
    work_butovanie:{name:"–ú–æ–Ω—Ç–∞–∂ —Å—Ç–æ–ª–±–∞ –±—É—Ç–æ–≤–∞–Ω–∏–µ–º",unit:"—à—Ç",crew:250,sell:700},
    work_pile_install:{name:"–ú–æ–Ω—Ç–∞–∂ –≤–∏–Ω—Ç–æ–≤–æ–π —Å–≤–∞–∏",unit:"—à—Ç",crew:950,sell:1400},
    work_cap_weld:{name:"–ü—Ä–∏–≤–∞—Ä–∫–∞ –æ–≥–æ–ª–æ–≤–∫–∞",unit:"—à—Ç",crew:0,sell:300},
    work_post_weld:{name:"–ü—Ä–∏–≤–∞—Ä–∫–∞ —Å—Ç–æ–ª–±–∞",unit:"—à—Ç",crew:0,sell:500},
    work_cps_fill:{name:"–ó–∞—Å—ã–ø–∫–∞ —Å–≤–∞–∏ –¶–ü–°",unit:"—à—Ç",crew:100,sell:200},
    work_lag_weld:{name:"–ü—Ä–∏–≤–∞—Ä–∫–∞ –ª–∞–≥–∏",unit:"—à—Ç",crew:150,sell:300},
    work_weld_paint:{name:"–û–∫—Ä–∞—Å–∫–∞ —Å–≤–∞—Ä–Ω–æ–≥–æ —à–≤–∞",unit:"—à—Ç",crew:50,sell:100},
    work_gitter_install:{name:"–ú–æ–Ω—Ç–∞–∂ —Å–µ–∫—Ü–∏–∏ –ì–∏—Ç—Ç–µ—Ä",unit:"—à—Ç",crew:250,sell:500},
    work_proflist_install:{name:"–ú–æ–Ω—Ç–∞–∂ –ø—Ä–æ—Ñ–ª–∏—Å—Ç–∞",unit:"–º¬≤",crew:150,sell:450},
    work_shtaketnik_install:{name:"–ú–æ–Ω—Ç–∞–∂ —à—Ç–∞–∫–µ—Ç–Ω–∏–∫–∞",unit:"–º¬≤",crew:65,sell:100},
    work_strip_install:{name:"–ú–æ–Ω—Ç–∞–∂ —Ñ–∏–Ω–∏—à–Ω–æ–π –ø–ª–∞–Ω–∫–∏",unit:"—à—Ç",crew:100,sell:200},
    work_gate_sliding:{name:"–ú–æ–Ω—Ç–∞–∂ –æ—Ç–∫–∞—Ç–Ω—ã—Ö –≤–æ—Ä–æ—Ç",unit:"–∫–æ–º–ø–ª",crew:18000,sell:26000},
    work_gate_fill:{name:"–ó–∞—à–∏–≤–∫–∞ –≤–æ—Ä–æ—Ç",unit:"–º¬≤",crew:150,sell:450},
    work_swing_leaf:{name:"–ú–æ–Ω—Ç–∞–∂ –≤–æ—Ä–æ—Ç–∏–Ω—ã",unit:"—à—Ç",crew:1000,sell:3000},
    work_swing_fill:{name:"–ó–∞—à–∏–≤–∫–∞ —Ä–∞—Å–ø–∞—à–Ω—ã—Ö",unit:"–º¬≤",crew:250,sell:450},
    work_swing_hardware:{name:"–ú–æ–Ω—Ç–∞–∂ —Ñ—É—Ä–Ω–∏—Ç—É—Ä—ã",unit:"–∫–æ–º–ø–ª",crew:1000,sell:1500},
    work_swing_paint:{name:"–û–∫—Ä–∞—Å–∫–∞ —à–≤–æ–≤ –≤–æ—Ä–æ—Ç–∞",unit:"–∫–æ–º–ø–ª",crew:0,sell:500},
    work_wicket_mount:{name:"–ú–æ–Ω—Ç–∞–∂ –∫–∞–ª–∏—Ç–∫–∏",unit:"—à—Ç",crew:8000,sell:12000},
    work_wicket_fill:{name:"–ó–∞—à–∏–≤–∫–∞ –∫–∞–ª–∏—Ç–∫–∏",unit:"–º¬≤",crew:250,sell:450},
    work_wicket_hardware:{name:"–§—É—Ä–Ω–∏—Ç—É—Ä–∞ –∫–∞–ª–∏—Ç–∫–∏",unit:"–∫–æ–º–ø–ª",crew:500,sell:1000},
    work_wicket_lock:{name:"–ú–æ–Ω—Ç–∞–∂ –∑–∞–º–∫–∞",unit:"—à—Ç",crew:1000,sell:1500},
    work_wicket_paint:{name:"–û–∫—Ä–∞—Å–∫–∞ —à–≤–æ–≤ –∫–∞–ª–∏—Ç–∫–∞",unit:"–∫–æ–º–ø–ª",crew:500,sell:600},
    work_wicket_builtin:{name:"–ú–æ–Ω—Ç–∞–∂ –≤—Å—Ç—Ä. –∫–∞–ª–∏—Ç–∫–∏",unit:"—à—Ç",crew:2000,sell:7000},
    work_automation:{name:"–ú–æ–Ω—Ç–∞–∂ –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∏",unit:"–∫–æ–º–ø–ª",crew:14000,sell:27000},
    work_piks_full:{name:"–ú–æ–Ω—Ç–∞–∂ –ü–ò–ö–° 2–º",unit:"—à—Ç",crew:2000,sell:4000},
    work_piks_half:{name:"–ú–æ–Ω—Ç–∞–∂ –ü–ò–ö–° 1–º",unit:"—à—Ç",crew:1500,sell:3000},
    work_demontage:{name:"–î–µ–º–æ–Ω—Ç–∞–∂ –∑–∞–±–æ—Ä–∞",unit:"–º.–ø.",crew:200,sell:250},
    work_delivery:{name:"–î–æ—Å—Ç–∞–≤–∫–∞",unit:"—Ä–µ–π—Å",crew:12000,sell:12000},
    work_transport:{name:"–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –±—Ä–∏–≥–∞–¥—ã",unit:"–∫–æ–º–ø–ª",crew:3000,sell:3000}
  }
};

let PRICES = JSON.parse(localStorage.getItem('fence_prices')) || JSON.parse(JSON.stringify(DEFAULT_PRICES));
function savePrices(){localStorage.setItem('fence_prices',JSON.stringify(PRICES));}

// ===== –°–û–°–¢–û–Ø–ù–ò–ï =====
const LETTERS = ['–ê','–ë','–í','–ì','–î','–ï'];
const COLORS = ['#e94560','#4ade80','#fbbf24','#60a5fa','#a78bfa','#f472b6'];

let state = {
  projectName: '',
  clientName: '',
  clientPhone: '',
  clientAddress: '',
  notes: '',
  sides: [],
  piks: [],
  excavator: 0,
  delivery: 0,
  discount: 0,
  prepayment: 33
};

// ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
document.addEventListener('DOMContentLoaded', () => {
  // –í–∫–ª–∞–¥–∫–∏
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => switchTab(tab.dataset.tab));
  });
  
  // –ü–æ–ª—è –≤–≤–æ–¥–∞
  document.getElementById('project-name').addEventListener('input', e => state.projectName = e.target.value);
  document.getElementById('client-name').addEventListener('input', e => state.clientName = e.target.value);
  document.getElementById('client-phone').addEventListener('input', e => state.clientPhone = e.target.value);
  document.getElementById('client-address').addEventListener('input', e => state.clientAddress = e.target.value);
  document.getElementById('notes').addEventListener('input', e => state.notes = e.target.value);
  document.getElementById('excavator-shifts').addEventListener('change', e => state.excavator = +e.target.value);
  document.getElementById('delivery-trips').addEventListener('input', e => state.delivery = +e.target.value);
  document.getElementById('discount').addEventListener('input', e => state.discount = +e.target.value);
  document.getElementById('prepayment').addEventListener('input', e => state.prepayment = +e.target.value);
  
  document.getElementById('add-side-btn').addEventListener('click', addSide);
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  loadState();
  if (state.sides.length === 0) addSide();
  renderSides();
  renderPrices();
  
  // –û–Ω–ª–∞–π–Ω —Å—Ç–∞—Ç—É—Å
  window.addEventListener('online', () => document.body.classList.remove('offline'));
  window.addEventListener('offline', () => document.body.classList.add('offline'));
  if (!navigator.onLine) document.body.classList.add('offline');
  
  // Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(e => console.log('SW error:', e));
  }
});

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === 'page-' + tab));
  if (tab === 'client' || tab === 'manager') calculateAll();
}

function saveState() {
  localStorage.setItem('fence_state', JSON.stringify(state));
}

function loadState() {
  const saved = localStorage.getItem('fence_state');
  if (saved) {
    try {
      const s = JSON.parse(saved);
      Object.assign(state, s);
      document.getElementById('project-name').value = state.projectName || '';
      document.getElementById('client-name').value = state.clientName || '';
      document.getElementById('client-phone').value = state.clientPhone || '';
      document.getElementById('client-address').value = state.clientAddress || '';
      document.getElementById('notes').value = state.notes || '';
      document.getElementById('excavator-shifts').value = state.excavator || 0;
      document.getElementById('delivery-trips').value = state.delivery || 0;
      document.getElementById('discount').value = state.discount || 0;
      document.getElementById('prepayment').value = state.prepayment || 33;
    } catch(e) {}
  }
}

function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show ' + type;
  setTimeout(() => t.className = 'toast', 2500);
}

// ===== –°–¢–û–†–û–ù–´ =====
function addSide() {
  if (state.sides.length >= 6) return showToast('–ú–∞–∫—Å–∏–º—É–º 6 —Å—Ç–æ—Ä–æ–Ω', 'error');
  const idx = state.sides.length;
  state.sides.push({
    id: Date.now(),
    letter: LETTERS[idx],
    color: COLORS[idx],
    length: 0,
    step: 2.5,
    material: 'proflist',
    height: 2.0,
    method: 'svai',
    pileLen: 2.0,
    pileDia: 76,
    fillCps: false,
    profThick: '04',
    profSides: 1,
    shtGap: 0,
    shtChess: false,
    gitterWire: 4,
    hasStrip: false,
    hasDemontage: false,
    demontagePrice: 250,
    demontageLen: 0,
    gates: [],
    wickets: []
  });
  renderSides();
  saveState();
}

function removeSide(idx) {
  if (state.sides.length <= 1) return showToast('–ú–∏–Ω–∏–º—É–º 1 —Å—Ç–æ—Ä–æ–Ω–∞', 'error');
  state.sides.splice(idx, 1);
  state.sides.forEach((s, i) => { s.letter = LETTERS[i]; s.color = COLORS[i]; });
  renderSides();
  saveState();
}

function updateSide(idx, key, val) {
  const s = state.sides[idx];
  if (key === 'length' || key === 'height' || key === 'pileLen' || key === 'shtGap' || key === 'demontagePrice' || key === 'demontageLen') val = parseFloat(val) || 0;
  else if (key === 'step' || key === 'pileDia' || key === 'gitterWire' || key === 'profSides') val = parseFloat(val);
  else if (key === 'fillCps' || key === 'shtChess' || key === 'hasStrip' || key === 'hasDemontage') val = !!val;
  s[key] = val;
  if (key === 'material') renderSides(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –¥–ª—è —Å–º–µ–Ω—ã –æ–ø—Ü–∏–π
  saveState();
}

function toggleSide(idx) {
  const el = document.getElementById('side-content-' + idx);
  el.classList.toggle('open');
}

function renderSides() {
  const c = document.getElementById('sides-container');
  c.innerHTML = state.sides.map((s, i) => `
    <div class="card" style="border-left:4px solid ${s.color}">
      <div class="side-header" style="background:${s.color}" onclick="toggleSide(${i})">
        <span style="color:#fff;font-weight:600">–°—Ç–æ—Ä–æ–Ω–∞ ${s.letter}</span>
        <button class="delete-btn" style="color:#fff" onclick="event.stopPropagation();removeSide(${i})">‚úï</button>
      </div>
      <div id="side-content-${i}" class="side-content open">
        <div class="form-row">
          <div class="form-group">
            <label>–î–ª–∏–Ω–∞, –º</label>
            <input type="number" step="0.1" value="${s.length}" onchange="updateSide(${i},'length',this.value)">
          </div>
          <div class="form-group">
            <label>–®–∞–≥ —Å—Ç–æ–ª–±–æ–≤</label>
            <select onchange="updateSide(${i},'step',this.value)">
              <option value="2.5" ${s.step==2.5?'selected':''}>2.5 –º</option>
              <option value="2" ${s.step==2?'selected':''}>2 –º</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>–ú–∞—Ç–µ—Ä–∏–∞–ª</label>
            <select onchange="updateSide(${i},'material',this.value)">
              <option value="gitter" ${s.material=='gitter'?'selected':''}>–ì–∏—Ç—Ç–µ—Ä</option>
              <option value="proflist" ${s.material=='proflist'?'selected':''}>–ü—Ä–æ—Ñ–ª–∏—Å—Ç</option>
              <option value="shtaketnik" ${s.material=='shtaketnik'?'selected':''}>–®—Ç–∞–∫–µ—Ç–Ω–∏–∫</option>
            </select>
          </div>
          <div class="form-group">
            <label>–í—ã—Å–æ—Ç–∞, –º</label>
            ${s.material === 'gitter' ? `
              <select onchange="updateSide(${i},'height',this.value)">
                <option value="1.53" ${s.height==1.53?'selected':''}>1.53 –º</option>
                <option value="1.73" ${s.height==1.73?'selected':''}>1.73 –º</option>
                <option value="2.03" ${s.height==2.03?'selected':''}>2.03 –º</option>
              </select>
            ` : `
              <select onchange="updateSide(${i},'height',this.value)">
                <option value="1.6" ${s.height==1.6?'selected':''}>1.6 –º</option>
                <option value="1.8" ${s.height==1.8?'selected':''}>1.8 –º</option>
                <option value="2.0" ${s.height==2.0?'selected':''}>2.0 –º</option>
                <option value="2.2" ${s.height==2.2?'selected':''}>2.2 –º</option>
              </select>
            `}
          </div>
        </div>
        ${s.material === 'gitter' ? `
          <div class="form-group">
            <label>–¢–æ–ª—â–∏–Ω–∞ –ø—Ä—É—Ç–∫–∞</label>
            <select onchange="updateSide(${i},'gitterWire',this.value)">
              <option value="3" ${s.gitterWire==3?'selected':''}>3 –º–º</option>
              <option value="4" ${s.gitterWire==4?'selected':''}>4 –º–º</option>
              <option value="5" ${s.gitterWire==5?'selected':''}>5 –º–º</option>
            </select>
          </div>
        ` : ''}
        ${s.material === 'proflist' ? `
          <div class="form-row">
            <div class="form-group">
              <label>–¢–æ–ª—â–∏–Ω–∞ –ª–∏—Å—Ç–∞</label>
              <select onchange="updateSide(${i},'profThick',this.value)">
                <option value="035" ${s.profThick=='035'?'selected':''}>0.35 –º–º</option>
                <option value="04" ${s.profThick=='04'?'selected':''}>0.4 –º–º</option>
                <option value="045" ${s.profThick=='045'?'selected':''}>0.45 –º–º</option>
              </select>
            </div>
            <div class="form-group">
              <label>–û–∫—Ä–∞—Å–∫–∞</label>
              <select onchange="updateSide(${i},'profSides',this.value)">
                <option value="1" ${s.profSides==1?'selected':''}>1-—Å—Ç–æ—Ä–æ–Ω–Ω—è—è</option>
                <option value="2" ${s.profSides==2?'selected':''}>2-—Å—Ç–æ—Ä–æ–Ω–Ω—è—è</option>
              </select>
            </div>
          </div>
        ` : ''}
        ${s.material === 'shtaketnik' ? `
          <div class="form-row">
            <div class="form-group">
              <label>–ó–∞–∑–æ—Ä, –º–º</label>
              <input type="number" value="${s.shtGap}" onchange="updateSide(${i},'shtGap',this.value)">
            </div>
            <div class="form-group">
              <label class="checkbox-label" style="margin-top:20px">
                <input type="checkbox" ${s.shtChess?'checked':''} onchange="updateSide(${i},'shtChess',this.checked)"> –®–∞—Ö–º–∞—Ç–∫–∞
              </label>
            </div>
          </div>
        ` : ''}
        ${s.material !== 'gitter' ? `
          <label class="checkbox-label">
            <input type="checkbox" ${s.hasStrip?'checked':''} onchange="updateSide(${i},'hasStrip',this.checked)"> –§–∏–Ω–∏—à–Ω–∞—è –ø–ª–∞–Ω–∫–∞
          </label>
        ` : ''}
        <div class="form-row" style="margin-top:12px">
          <div class="form-group">
            <label>–£—Å—Ç–∞–Ω–æ–≤–∫–∞</label>
            <select onchange="updateSide(${i},'method',this.value)">
              <option value="svai" ${s.method=='svai'?'selected':''}>–í–∏–Ω—Ç–æ–≤—ã–µ —Å–≤–∞–∏</option>
              <option value="butovanie" ${s.method=='butovanie'?'selected':''}>–ë—É—Ç–æ–≤–∞–Ω–∏–µ</option>
            </select>
          </div>
          ${s.method === 'svai' ? `
            <div class="form-group">
              <label>–î–ª–∏–Ω–∞ —Å–≤–∞–∏</label>
              <select onchange="updateSide(${i},'pileLen',this.value)">
                <option value="1.5" ${s.pileLen==1.5?'selected':''}>1.5 –º</option>
                <option value="2" ${s.pileLen==2?'selected':''}>2.0 –º</option>
                <option value="2.5" ${s.pileLen==2.5?'selected':''}>2.5 –º</option>
                <option value="3" ${s.pileLen==3?'selected':''}>3.0 –º</option>
              </select>
            </div>
          ` : ''}
        </div>
        ${s.method === 'svai' ? `
          <label class="checkbox-label">
            <input type="checkbox" ${s.fillCps?'checked':''} onchange="updateSide(${i},'fillCps',this.checked)"> –ó–∞—Å—ã–ø–∫–∞ –¶–ü–°
          </label>
        ` : ''}
        <label class="checkbox-label" style="margin-top:8px">
          <input type="checkbox" ${s.hasDemontage?'checked':''} onchange="updateSide(${i},'hasDemontage',this.checked)"> –î–µ–º–æ–Ω—Ç–∞–∂ —Å—Ç–∞—Ä–æ–≥–æ –∑–∞–±–æ—Ä–∞
        </label>
        ${s.hasDemontage ? `
          <div class="form-row">
            <div class="form-group">
              <label>–î–ª–∏–Ω–∞ –¥–µ–º–æ–Ω—Ç–∞–∂–∞, –º</label>
              <input type="number" value="${s.demontageLen}" onchange="updateSide(${i},'demontageLen',this.value)">
            </div>
            <div class="form-group">
              <label>–¶–µ–Ω–∞ –∑–∞ –º–µ—Ç—Ä, ‚ÇΩ</label>
              <input type="number" step="50" value="${s.demontagePrice}" onchange="updateSide(${i},'demontagePrice',this.value)">
            </div>
          </div>
        ` : ''}
        
        <!-- –í–æ—Ä–æ—Ç–∞ -->
        <div class="subsection-title" style="margin-top:16px">–í–æ—Ä–æ—Ç–∞</div>
        <div id="gates-${i}">${renderGates(i)}</div>
        <button class="add-btn" onclick="addGate(${i})">+ –î–æ–±–∞–≤–∏—Ç—å –≤–æ—Ä–æ—Ç–∞</button>
        
        <!-- –ö–∞–ª–∏—Ç–∫–∏ -->
        <div class="subsection-title">–ö–∞–ª–∏—Ç–∫–∏</div>
        <div id="wickets-${i}">${renderWickets(i)}</div>
        <button class="add-btn" onclick="addWicket(${i})">+ –î–æ–±–∞–≤–∏—Ç—å –∫–∞–ª–∏—Ç–∫—É</button>
      </div>
    </div>
  `).join('');
}

// ===== –í–û–†–û–¢–ê =====
function addGate(sideIdx) {
  const s = state.sides[sideIdx];
  s.gates.push({
    id: Date.now(),
    type: 'sliding',
    width: 4,
    hasAutomation: false,
    extraRemotes: 0,
    hasBuiltinWicket: false,
    hasLock: false,
    hasWicketNearby: false
  });
  renderSides();
  saveState();
}

function removeGate(sideIdx, gateIdx) {
  state.sides[sideIdx].gates.splice(gateIdx, 1);
  renderSides();
  saveState();
}

function updateGate(sideIdx, gateIdx, key, val) {
  const g = state.sides[sideIdx].gates[gateIdx];
  if (key === 'width' || key === 'extraRemotes') val = parseFloat(val);
  else if (key === 'hasAutomation' || key === 'hasBuiltinWicket' || key === 'hasLock' || key === 'hasWicketNearby') val = !!val;
  g[key] = val;
  if (key === 'type') renderSides();
  saveState();
}

function renderGates(sideIdx) {
  const s = state.sides[sideIdx];
  const isGitter = s.material === 'gitter';
  return s.gates.map((g, gi) => `
    <div class="gate-item">
      <div style="display:flex;justify-content:space-between;margin-bottom:8px">
        <strong>–í–æ—Ä–æ—Ç–∞ ${gi+1}</strong>
        <button class="delete-btn" onclick="removeGate(${sideIdx},${gi})">‚úï</button>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>–¢–∏–ø</label>
          <select onchange="updateGate(${sideIdx},${gi},'type',this.value)">
            <option value="sliding" ${g.type=='sliding'?'selected':''}>–û—Ç–∫–∞—Ç–Ω—ã–µ</option>
            <option value="swing" ${g.type=='swing'?'selected':''}>–†–∞—Å–ø–∞—à–Ω—ã–µ</option>
          </select>
        </div>
        <div class="form-group">
          <label>–®–∏—Ä–∏–Ω–∞, –º</label>
          <select onchange="updateGate(${sideIdx},${gi},'width',this.value)">
            ${g.type === 'sliding' ? `
              <option value="3" ${g.width==3?'selected':''}>3 –º</option>
              <option value="3.5" ${g.width==3.5?'selected':''}>3.5 –º</option>
              <option value="4" ${g.width==4?'selected':''}>4 –º</option>
              <option value="4.5" ${g.width==4.5?'selected':''}>4.5 –º</option>
              <option value="5" ${g.width==5?'selected':''}>5 –º</option>
              <option value="5.5" ${g.width==5.5?'selected':''}>5.5 –º</option>
              <option value="6" ${g.width==6?'selected':''}>6 –º</option>
            ` : `
              <option value="3" ${g.width==3?'selected':''}>3 –º</option>
              <option value="3.5" ${g.width==3.5?'selected':''}>3.5 –º</option>
              <option value="4" ${g.width==4?'selected':''}>4 –º</option>
            `}
          </select>
        </div>
      </div>
      ${g.type === 'sliding' ? `
        <label class="checkbox-label">
          <input type="checkbox" ${g.hasAutomation?'checked':''} onchange="updateGate(${sideIdx},${gi},'hasAutomation',this.checked)"> –ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞
        </label>
        ${g.hasAutomation ? `
          <div class="form-group" style="margin-top:8px">
            <label>–î–æ–ø. –±—Ä–µ–ª–æ–∫–∏</label>
            <select onchange="updateGate(${sideIdx},${gi},'extraRemotes',this.value)">
              <option value="0" ${g.extraRemotes==0?'selected':''}>0</option>
              <option value="1" ${g.extraRemotes==1?'selected':''}>1</option>
              <option value="2" ${g.extraRemotes==2?'selected':''}>2</option>
              <option value="3" ${g.extraRemotes==3?'selected':''}>3</option>
            </select>
          </div>
        ` : ''}
        <label class="checkbox-label">
          <input type="checkbox" ${g.hasWicketNearby?'checked':''} onchange="updateGate(${sideIdx},${gi},'hasWicketNearby',this.checked)"> –ö–∞–ª–∏—Ç–∫–∞ —Ä—è–¥–æ–º (5 —Å–≤–∞–π)
        </label>
      ` : ''}
      <label class="checkbox-label">
        <input type="checkbox" ${g.hasBuiltinWicket?'checked':''} onchange="updateGate(${sideIdx},${gi},'hasBuiltinWicket',this.checked)"> –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∫–∞–ª–∏—Ç–∫–∞
      </label>
      ${g.hasBuiltinWicket ? `
        <label class="checkbox-label">
          <input type="checkbox" ${g.hasLock?'checked':''} onchange="updateGate(${sideIdx},${gi},'hasLock',this.checked)"> –í—Ä–µ–∑–Ω–æ–π –∑–∞–º–æ–∫
        </label>
      ` : ''}
    </div>
  `).join('');
}

// ===== –ö–ê–õ–ò–¢–ö–ò =====
function addWicket(sideIdx) {
  const s = state.sides[sideIdx];
  s.wickets.push({
    id: Date.now(),
    position: 'separate',
    hasLock: false
  });
  renderSides();
  saveState();
}

function removeWicket(sideIdx, wIdx) {
  state.sides[sideIdx].wickets.splice(wIdx, 1);
  renderSides();
  saveState();
}

function updateWicket(sideIdx, wIdx, key, val) {
  const w = state.sides[sideIdx].wickets[wIdx];
  if (key === 'hasLock') val = !!val;
  w[key] = val;
  saveState();
}

function renderWickets(sideIdx) {
  const s = state.sides[sideIdx];
  return s.wickets.map((w, wi) => `
    <div class="wicket-item">
      <div style="display:flex;justify-content:space-between;margin-bottom:8px">
        <strong>–ö–∞–ª–∏—Ç–∫–∞ ${wi+1}</strong>
        <button class="delete-btn" onclick="removeWicket(${sideIdx},${wi})">‚úï</button>
      </div>
      <div class="form-group">
        <label>–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</label>
        <select onchange="updateWicket(${sideIdx},${wi},'position',this.value)">
          <option value="separate" ${w.position=='separate'?'selected':''}>–û—Ç–¥–µ–ª—å–Ω–æ —Å—Ç–æ—è—â–∞—è (2 —Å–≤–∞–∏)</option>
          <option value="nearby_swing" ${w.position=='nearby_swing'?'selected':''}>–†—è–¥–æ–º —Å —Ä–∞—Å–ø–∞—à–Ω—ã–º–∏ (1 —Å–≤–∞—è)</option>
          <option value="nearby_sliding" ${w.position=='nearby_sliding'?'selected':''}>–†—è–¥–æ–º —Å –æ—Ç–∫–∞—Ç–Ω—ã–º–∏ (2 —Å–≤–∞–∏)</option>
        </select>
      </div>
      <label class="checkbox-label">
        <input type="checkbox" ${w.hasLock?'checked':''} onchange="updateWicket(${sideIdx},${wi},'hasLock',this.checked)"> –í—Ä–µ–∑–Ω–æ–π –∑–∞–º–æ–∫
      </label>
    </div>
  `).join('');
}

// ===== –ü–ò–ö–° =====
function addPiks() {
  state.piks.push({
    id: Date.now(),
    count: 1,
    isHalf: false,
    panelColor: 'yellow',
    capColor: '7024'
  });
  renderPiks();
  saveState();
}

function removePiks(idx) {
  state.piks.splice(idx, 1);
  renderPiks();
  saveState();
}

function updatePiks(idx, key, val) {
  const p = state.piks[idx];
  if (key === 'count') val = parseInt(val) || 1;
  else if (key === 'isHalf') val = !!val;
  p[key] = val;
  saveState();
}

function renderPiks() {
  const c = document.getElementById('piks-container');
  c.innerHTML = state.piks.map((p, i) => `
    <div class="gate-item">
      <div style="display:flex;justify-content:space-between;margin-bottom:8px">
        <strong>–ü–ò–ö–° ${i+1}</strong>
        <button class="delete-btn" onclick="removePiks(${i})">‚úï</button>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
          <input type="number" min="1" value="${p.count}" onchange="updatePiks(${i},'count',this.value)">
        </div>
        <div class="form-group">
          <label>–í—ã—Å–æ—Ç–∞</label>
          <select onchange="updatePiks(${i},'isHalf',this.value==='true')">
            <option value="false" ${!p.isHalf?'selected':''}>2–º (—Ü–µ–ª—ã–π)</option>
            <option value="true" ${p.isHalf?'selected':''}>1–º (–ø–æ–ª–æ–≤–∏–Ω–Ω—ã–π)</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>–¶–≤–µ—Ç –ø–∞–Ω–µ–ª–µ–π</label>
          <select onchange="updatePiks(${i},'panelColor',this.value)">
            <option value="yellow" ${p.panelColor=='yellow'?'selected':''}>–ñ—ë–ª—Ç—ã–π –∫–∏—Ä–ø–∏—á</option>
            <option value="red" ${p.panelColor=='red'?'selected':''}>–ö—Ä–∞—Å–Ω—ã–π –∫–∏—Ä–ø–∏—á</option>
            <option value="brown" ${p.panelColor=='brown'?'selected':''}>–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π –∫–∏—Ä–ø–∏—á</option>
            <option value="graphite" ${p.panelColor=='graphite'?'selected':''}>–ì—Ä–∞—Ñ–∏—Ç–æ–≤—ã–π –∫–∏—Ä–ø–∏—á</option>
          </select>
        </div>
        <div class="form-group">
          <label>–¶–≤–µ—Ç –∫—Ä—ã—à–∫–∏</label>
          <select onchange="updatePiks(${i},'capColor',this.value)">
            <option value="7024" ${p.capColor=='7024'?'selected':''}>RAL 7024 –ì—Ä–∞—Ñ–∏—Ç</option>
            <option value="8017" ${p.capColor=='8017'?'selected':''}>RAL 8017 –ö–æ—Ä–∏—á–Ω–µ–≤—ã–π</option>
            <option value="6005" ${p.capColor=='6005'?'selected':''}>RAL 6005 –ó–µ–ª—ë–Ω—ã–π</option>
            <option value="3005" ${p.capColor=='3005'?'selected':''}>RAL 3005 –í–∏—à–Ω—ë–≤—ã–π</option>
          </select>
        </div>
      </div>
    </div>
  `).join('');
}

// ===== –†–ê–°–ß–Å–¢ =====
function getPrice(type, code) {
  const p = PRICES[type][code];
  return p || {name:'?',unit:'—à—Ç',buy:0,sell:0,crew:0};
}

function calculateAll() {
  const result = { sides: [], extras: { materials: [], works: [] }, totals: { buy: 0, sell: 0, crew: 0 } };
  
  // –†–∞—Å—á—ë—Ç –∫–∞–∂–¥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
  state.sides.forEach((s, si) => {
    const sideResult = calculateSide(s);
    result.sides.push(sideResult);
    result.totals.buy += sideResult.totals.buy;
    result.totals.sell += sideResult.totals.sell;
    result.totals.crew += sideResult.totals.crew;
  });
  
  // –≠–∫—Å–∫–∞–≤–∞—Ç–æ—Ä
  if (state.excavator > 0) {
    const p = getPrice('materials', 'excavator');
    result.extras.materials.push({ name: p.name, unit: p.unit, qty: state.excavator, buy: p.buy, sell: p.sell, sumBuy: p.buy * state.excavator, sumSell: p.sell * state.excavator });
    result.totals.buy += p.buy * state.excavator;
    result.totals.sell += p.sell * state.excavator;
  }
  
  // –î–æ—Å—Ç–∞–≤–∫–∞
  if (state.delivery > 0) {
    const p = getPrice('works', 'work_delivery');
    result.extras.works.push({ name: p.name, unit: p.unit, qty: state.delivery, crew: p.crew, sell: p.sell, sumCrew: p.crew * state.delivery, sumSell: p.sell * state.delivery });
    result.totals.sell += p.sell * state.delivery;
    result.totals.crew += p.crew * state.delivery;
  }
  
  // –ü–ò–ö–°
  state.piks.forEach(piks => {
    const piksResult = calculatePiks(piks);
    result.extras.materials.push(...piksResult.materials);
    result.extras.works.push(...piksResult.works);
    result.totals.buy += piksResult.totals.buy;
    result.totals.sell += piksResult.totals.sell;
    result.totals.crew += piksResult.totals.crew;
  });
  
  // –°–∫–∏–¥–∫–∞
  if (state.discount > 0) {
    result.discountAmount = Math.round(result.totals.sell * state.discount / 100);
    result.totals.sell -= result.discountAmount;
  }
  
  // –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞
  result.prepayment = Math.ceil(result.totals.sell * state.prepayment / 100 / 10000) * 10000;
  
  renderEstimates(result);
  return result;
}

function calculateSide(s) {
  const result = { 
    letter: s.letter, 
    color: s.color,
    length: s.length,
    material: s.material,
    fence: { materials: [], works: [] }, 
    gates: [], 
    wickets: [],
    totals: { buy: 0, sell: 0, crew: 0 } 
  };
  
  if (s.length <= 0) return result;
  
  const posts = Math.ceil(s.length / s.step) + 1;
  const m = result.fence.materials;
  const w = result.fence.works;
  
  // –°—Ç–æ–ª–±—ã
  if (s.method === 'butovanie') {
    addMat(m, 'post_60x60_3m', posts);
    addMat(m, 'cap_plastic_60', posts);
    const gravel = Math.ceil(posts * 35 / 40);
    addMat(m, 'gravel_bag', gravel);
    addWork(w, 'work_drilling', posts);
    addWork(w, 'work_butovanie', posts);
  } else {
    const pileCode = 'pile_76_' + Math.round(s.pileLen * 10);
    addMat(m, pileCode, posts);
    addMat(m, 'cap_76', posts);
    addMat(m, 'post_60x60_2m', posts);
    addMat(m, 'cap_plastic_60', posts);
    addWork(w, 'work_pile_install', posts);
    addWork(w, 'work_cap_weld', posts);
    addWork(w, 'work_post_weld', posts);
    if (s.fillCps) {
      const cps = Math.ceil(posts * s.pileLen * 4.5 * 1.5 / 25);
      addMat(m, 'cps_bag', cps);
      addWork(w, 'work_cps_fill', posts);
    }
  }
  
  // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
  if (s.material === 'gitter') {
    const sections = Math.ceil(s.length / s.step);
    const h = Math.round(s.height * 100);
    const code = `gitter_${h}_${s.gitterWire}`;
    addMat(m, code, sections);
    const clamps = Math.ceil((posts * 3 + 10) / 50) * 50;
    addMat(m, 'clamp', clamps);
    addWork(w, 'work_gitter_install', sections);
  } else {
    const lagsCount = s.height >= 2 ? 3 : 2;
    const lags = Math.ceil(s.length * lagsCount / 6);
    addMat(m, 'lag_40x20_6m', lags);
    const weldPoints = posts * lagsCount;
    addWork(w, 'work_lag_weld', weldPoints);
    addWork(w, 'work_weld_paint', weldPoints);
    const paint = Math.ceil(s.length / 60);
    addMat(m, 'paint_touch', paint);
    
    if (s.material === 'proflist') {
      const sheets = Math.ceil(s.length / 1.15);
      const h = Math.round(s.height * 10);
      const code = `proflist_${s.profThick}_${s.profSides}_${h}`;
      addMat(m, code, sheets);
      const screws = Math.ceil(s.length * 10 / 100) * 100 + 100;
      addMat(m, 'screw_55x19', screws);
      const area = Math.ceil(s.length * s.height);
      addWork(w, 'work_proflist_install', area);
    } else {
      const width = 125, gap = s.shtGap || 0;
      let pieces = Math.ceil(s.length * 1000 / (width + gap));
      if (s.shtChess) pieces *= 2;
      const h = Math.round(s.height * 10);
      addMat(m, `shtaketnik_${h}`, pieces);
      const screws = Math.ceil(s.length * 10 / 100) * 100 + 100;
      addMat(m, 'screw_55x19', screws);
      const area = Math.ceil(s.length * s.height);
      addWork(w, 'work_shtaketnik_install', area);
    }
    
    if (s.hasStrip) {
      const strips = Math.ceil(s.length / 2 + 1);
      addMat(m, 'finishing_strip', strips);
      addWork(w, 'work_strip_install', strips);
    }
  }
  
  // –†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏
  addMat(m, 'consumables', 1);
  
  // –î–µ–º–æ–Ω—Ç–∞–∂
  if (s.hasDemontage && s.demontageLen > 0) {
    w.push({ name: `–î–µ–º–æ–Ω—Ç–∞–∂ (${s.demontagePrice}‚ÇΩ/–º)`, unit: '–º.–ø.', qty: s.demontageLen, crew: Math.round(s.demontagePrice * 0.8), sell: s.demontagePrice, sumCrew: Math.round(s.demontageLen * s.demontagePrice * 0.8), sumSell: s.demontageLen * s.demontagePrice });
  }
  
  // –í–æ—Ä–æ—Ç–∞
  s.gates.forEach(g => {
    const gr = calculateGate(g, s);
    result.gates.push(gr);
  });
  
  // –ö–∞–ª–∏—Ç–∫–∏
  s.wickets.forEach(wk => {
    const wr = calculateWicket(wk, s);
    result.wickets.push(wr);
  });
  
  // –ü–æ–¥—Å—á—ë—Ç –∏—Ç–æ–≥–æ–≤
  m.forEach(i => { result.totals.buy += i.sumBuy; result.totals.sell += i.sumSell; });
  w.forEach(i => { result.totals.crew += i.sumCrew; result.totals.sell += i.sumSell; });
  result.gates.forEach(g => { result.totals.buy += g.totals.buy; result.totals.sell += g.totals.sell; result.totals.crew += g.totals.crew; });
  result.wickets.forEach(wk => { result.totals.buy += wk.totals.buy; result.totals.sell += wk.totals.sell; result.totals.crew += wk.totals.crew; });
  
  return result;
}

function calculateGate(g, side) {
  const result = { type: g.type, width: g.width, materials: [], works: [], totals: { buy: 0, sell: 0, crew: 0 } };
  const m = result.materials, w = result.works;
  const isGitter = side.material === 'gitter';
  const pileLen = side.pileLen || 2;
  
  if (g.type === 'sliding') {
    const gw = Math.round(g.width * 10);
    const gateCode = isGitter ? `gate_gitter_sliding_${gw}` : `gate_sliding_${gw}`;
    addMat(m, gateCode, 1);
    addMat(m, 'foundation_sliding', 1);
    const piles = g.hasWicketNearby ? 5 : 6;
    addMat(m, `pile_76_${Math.round(pileLen * 10)}`, piles);
    addWork(w, 'work_gate_sliding', 1);
    if (side.fillCps) {
      const cps = Math.ceil(piles * pileLen * 4.5 * 1.5 / 25);
      addMat(m, 'cps_bag', cps);
      addWork(w, 'work_cps_fill', piles);
    }
    if (!isGitter) {
      const area = g.width * side.height;
      if (side.material === 'proflist') {
        const sheets = Math.ceil(g.width / 1.15);
        const h = Math.round(side.height * 10);
        addMat(m, `proflist_${side.profThick}_${side.profSides}_${h}`, sheets);
        addWork(w, 'work_gate_fill', Math.ceil(area));
      } else {
        const width = 125, gap = side.shtGap || 0;
        let pieces = Math.ceil(g.width * 1000 / (width + gap)) + 4;
        if (side.shtChess) pieces *= 2;
        const h = Math.round(side.height * 10);
        addMat(m, `shtaketnik_${h}`, pieces);
        addWork(w, 'work_gate_fill', Math.ceil(area));
      }
    }
    if (g.hasAutomation) {
      addMat(m, 'came_bx608', 1);
      addMat(m, 'gear_rack', Math.ceil(g.width + 1));
      addMat(m, 'photo_sensor', 1);
      addMat(m, 'wires_gofra', 1);
      addMat(m, 'lamp_signal', 1);
      addMat(m, 'antenna', 1);
      if (g.extraRemotes > 0) addMat(m, 'remote', g.extraRemotes);
      addWork(w, 'work_automation', 1);
    }
  } else {
    const gw = Math.round(g.width * 10);
    const gateCode = isGitter ? `gate_gitter_swing_${gw}` : `gate_swing_${gw}`;
    addMat(m, gateCode, 1);
    addMat(m, `pile_89_${Math.round(pileLen * 10)}`, 2);
    addMat(m, 'cap_89', 2);
    addMat(m, 'post_80x80_3m', 2);
    addMat(m, 'cap_plastic_80', 2);
    addWork(w, 'work_pile_install', 2);
    addWork(w, 'work_cap_weld', 2);
    addWork(w, 'work_post_weld', 2);
    addWork(w, 'work_swing_leaf', 2);
    addWork(w, 'work_swing_hardware', 1);
    addWork(w, 'work_swing_paint', 1);
    if (side.fillCps) {
      const cps = Math.ceil(2 * pileLen * 6.2 * 1.5 / 25);
      addMat(m, 'cps_bag', cps);
      addWork(w, 'work_cps_fill', 2);
    }
    if (!isGitter) {
      const area = g.width * side.height;
      if (side.material === 'proflist') {
        const sheets = Math.ceil(g.width / 1.15);
        const h = Math.round(side.height * 10);
        addMat(m, `proflist_${side.profThick}_${side.profSides}_${h}`, sheets);
      } else {
        const width = 125, gap = side.shtGap || 0;
        let pieces = Math.ceil(g.width * 1000 / (width + gap)) + 4;
        if (side.shtChess) pieces *= 2;
        const h = Math.round(side.height * 10);
        addMat(m, `shtaketnik_${h}`, pieces);
      }
      addWork(w, 'work_swing_fill', Math.ceil(area));
    }
  }
  
  if (g.hasBuiltinWicket) {
    addMat(m, 'wicket_builtin', 1);
    if (g.hasLock) { addMat(m, 'lock_mortise', 1); addWork(w, 'work_wicket_lock', 1); }
    addWork(w, 'work_wicket_builtin', 1);
  }
  
  m.forEach(i => { result.totals.buy += i.sumBuy; result.totals.sell += i.sumSell; });
  w.forEach(i => { result.totals.crew += i.sumCrew; result.totals.sell += i.sumSell; });
  return result;
}

function calculateWicket(wk, side) {
  const result = { materials: [], works: [], totals: { buy: 0, sell: 0, crew: 0 } };
  const m = result.materials, w = result.works;
  const isGitter = side.material === 'gitter';
  const pileLen = side.pileLen || 2;
  
  addMat(m, isGitter ? 'wicket_gitter' : 'wicket_standard', 1);
  
  const piles = wk.position === 'nearby_swing' ? 1 : 2;
  addMat(m, `pile_89_${Math.round(pileLen * 10)}`, piles);
  addMat(m, 'cap_89', piles);
  addMat(m, 'post_80x80_3m', piles);
  addMat(m, 'cap_plastic_80', piles);
  
  if (wk.hasLock) addMat(m, 'lock_mortise', 1);
  
  addWork(w, 'work_pile_install', piles);
  addWork(w, 'work_cap_weld', piles);
  addWork(w, 'work_post_weld', piles);
  addWork(w, 'work_wicket_mount', 1);
  addWork(w, 'work_wicket_hardware', 1);
  addWork(w, 'work_wicket_paint', 1);
  if (wk.hasLock) addWork(w, 'work_wicket_lock', 1);
  
  if (side.fillCps) {
    const cps = Math.ceil(piles * pileLen * 6.2 * 1.5 / 25);
    addMat(m, 'cps_bag', cps);
    addWork(w, 'work_cps_fill', piles);
  }
  
  if (!isGitter) {
    const area = 1 * side.height;
    if (side.material === 'proflist') {
      const h = Math.round(side.height * 10);
      addMat(m, `proflist_${side.profThick}_${side.profSides}_${h}`, 1);
    } else {
      const width = 125, gap = side.shtGap || 0;
      let pieces = Math.ceil(1000 / (width + gap)) + 4;
      if (side.shtChess) pieces *= 2;
      const h = Math.round(side.height * 10);
      addMat(m, `shtaketnik_${h}`, pieces);
    }
    addWork(w, 'work_wicket_fill', Math.ceil(area));
  }
  
  m.forEach(i => { result.totals.buy += i.sumBuy; result.totals.sell += i.sumSell; });
  w.forEach(i => { result.totals.crew += i.sumCrew; result.totals.sell += i.sumSell; });
  return result;
}

function calculatePiks(p) {
  const result = { materials: [], works: [], totals: { buy: 0, sell: 0, crew: 0 } };
  const m = result.materials, w = result.works;
  
  const panels = p.count * (p.isHalf ? 7 : 14);
  const guides = p.count * (p.isHalf ? 2 : 4);
  const fasteners = Math.ceil((guides * 4 + panels * 2 + 50) / 100) * 100;
  
  addMat(m, `piks_${p.panelColor}`, panels);
  addMat(m, 'piks_cap', p.count);
  addMat(m, 'piks_guide', guides);
  addMat(m, 'piks_fastener', fasteners);
  addWork(w, p.isHalf ? 'work_piks_half' : 'work_piks_full', p.count);
  
  m.forEach(i => { result.totals.buy += i.sumBuy; result.totals.sell += i.sumSell; });
  w.forEach(i => { result.totals.crew += i.sumCrew; result.totals.sell += i.sumSell; });
  return result;
}

function addMat(arr, code, qty) {
  if (qty <= 0) return;
  const p = getPrice('materials', code);
  arr.push({ code, name: p.name, unit: p.unit, qty, buy: p.buy, sell: p.sell, sumBuy: Math.round(p.buy * qty), sumSell: Math.round(p.sell * qty) });
}

function addWork(arr, code, qty) {
  if (qty <= 0) return;
  const p = getPrice('works', code);
  arr.push({ code, name: p.name, unit: p.unit, qty, crew: p.crew || 0, sell: p.sell, sumCrew: Math.round((p.crew || 0) * qty), sumSell: Math.round(p.sell * qty) });
}
}">–°—Ç–æ—Ä–æ–Ω–∞ ${s.letter}</div>
          <table>
            <tr><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th class="text-right">–ö–æ–ª</th><th class="text-right">–ó–∞–∫—É–ø</th><th class="text-right">–ü—Ä–æ–¥–∞–∂–∞</th><th class="text-right">–ú–∞—Ä–∂–∞</th></tr>
            ${s.fence.materials.map(m => `<tr><td>${m.name}</td><td class="text-right">${m.qty}</td><td class="text-right">${fmt(m.sumBuy)}</td><td class="text-right">${fmt(m.sumSell)}</td><td class="text-right">${fmt(m.sumSell - m.sumBuy)}</td></tr>`).join('')}
            ${s.fence.works.map(w => `<tr><td>${w.name}</td><td class="text-right">${w.qty}</td><td class="text-right">${fmt(w.sumCrew)}</td><td class="text-right">${fmt(w.sumSell)}</td><td class="text-right">${fmt(w.sumSell - w.sumCrew)}</td></tr>`).join('')}
            ${s.gates.flatMap(g => [...g.materials.map(m => `<tr><td>${m.name}</td><td class="text-right">${m.qty}</td><td class="text-right">${fmt(m.sumBuy)}</td><td class="text-right">${fmt(m.sumSell)}</td><td class="text-right">${fmt(m.sumSell - m.sumBuy)}</td></tr>`), ...g.works.map(w => `<tr><td>${w.name}</td><td class="text-right">${w.qty}</td><td class="text-right">${fmt(w.sumCrew)}</td><td class="text-right">${fmt(w.sumSell)}</td><td class="text-right">${fmt(w.sumSell - w.sumCrew)}</td></tr>`)]).join('')}
            ${s.wickets.flatMap(wk => [...wk.materials.map(m => `<tr><td>${m.name}</td><td class="text-right">${m.qty}</td><td class="text-right">${fmt(m.sumBuy)}</td><td class="text-right">${fmt(m.sumSell)}</td><td class="text-right">${fmt(m.sumSell - m.sumBuy)}</td></tr>`), ...wk.works.map(w => `<tr><td>${w.name}</td><td class="text-right">${w.qty}</td><td class="text-right">${fmt(w.sumCrew)}</td><td class="text-right">${fmt(w.sumSell)}</td><td class="text-right">${fmt(w.sumSell - w.sumCrew)}</td></tr>`)]).join('')}
          </table>
        `;
      }).join('')}
      
      <div class="totals" style="margin-top:20px">
        <div class="total-row"><span class="total-label">–ó–∞–∫—É–ø –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</span><span class="total-value">${fmt(r.totals.buy)}</span></div>
        <div class="total-row"><span class="total-label">–û–ø–ª–∞—Ç–∞ –±—Ä–∏–≥–∞–¥–µ</span><span class="total-value">${fmt(r.totals.crew)}</span></div>
        <div class="total-row"><span class="total-label">–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</span><span class="total-value">${fmt(r.totals.buy + r.totals.crew)}</span></div>
        ${r.discountAmount ? `<div class="total-row"><span class="total-label">–°–∫–∏–¥–∫–∞</span><span class="total-value">-${fmt(r.discountAmount)}</span></div>` : ''}
        <div class="total-row"><span class="total-label">–ü—Ä–æ–¥–∞–∂–∞</span><span class="total-value accent">${fmt(r.totals.sell)}</span></div>
        <div class="total-row"><span class="total-label">–ú–∞—Ä–∂–∞</span><span class="total-value success">${fmt(margin)} (${marginPct}%)</span></div>
      </div>
    </div>
  `;
  document.getElementById('estimate-manager').innerHTML = html;
}

function fmt(n) { return Math.round(n).toLocaleString('ru-RU') + ' ‚ÇΩ'; }

// ===== –≠–ö–°–ü–û–†–¢ =====
function savePDF(full) {
  showToast('PDF –≥–µ–Ω–µ—Ä–∞—Ü–∏—è... (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Print to PDF)', 'success');
  const content = document.getElementById(full ? 'estimate-manager' : 'estimate-client').innerHTML;
  const win = window.open('', '_blank');
  win.document.write(`<!DOCTYPE html><html><head><title>–°–º–µ—Ç–∞ ${state.projectName}</title><style>body{font-family:Arial,sans-serif;padding:20px;max-width:800px;margin:0 auto}table{width:100%;border-collapse:collapse;margin:10px 0}th,td{border:1px solid #ddd;padding:6px;text-align:left}th{background:#f5f5f5}.text-right{text-align:right}.section-title{background:#e94560;color:#fff;padding:10px;margin:15px 0 10px;border-radius:4px}.subsection-title{background:#eee;padding:8px;margin:10px 0}.totals{background:#f9f9f9;padding:15px;margin-top:15px;border-radius:4px}.total-row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #eee}.accent{color:#e94560;font-size:18px;font-weight:bold}.success{color:#22c55e}</style></head><body>${content}</body></html>`);
  win.document.close();
  win.print();
}

function sharePDF() {
  if (navigator.share) {
    navigator.share({ title: `–°–º–µ—Ç–∞ ${state.projectName}`, text: `–°–º–µ—Ç–∞ –∑–∞–±–æ—Ä–∞: ${state.projectName}` });
  } else {
    savePDF(false);
  }
}

function saveExcel() {
  showToast('Excel: —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É –≤ Excel', 'success');
  const content = document.getElementById('estimate-manager').innerHTML;
  const win = window.open('', '_blank');
  win.document.write(`<!DOCTYPE html><html><head><title>–°–º–µ—Ç–∞ ${state.projectName}</title></head><body>${content}</body></html>`);
  win.document.close();
}

// ===== –¶–ï–ù–´ =====
function renderPrices() {
  const cats = [
    { name: '–ì–∏—Ç—Ç–µ—Ä', codes: Object.keys(PRICES.materials).filter(k => k.startsWith('gitter')) },
    { name: '–ü—Ä–æ—Ñ–ª–∏—Å—Ç', codes: Object.keys(PRICES.materials).filter(k => k.startsWith('proflist')) },
    { name: '–®—Ç–∞–∫–µ—Ç–Ω–∏–∫', codes: Object.keys(PRICES.materials).filter(k => k.startsWith('shtaketnik') || k === 'finishing_strip') },
    { name: '–°—Ç–æ–ª–±—ã –∏ —Å–≤–∞–∏', codes: ['post_60x60_2m','post_60x60_3m','post_80x80_3m','cap_plastic_60','cap_plastic_80','pile_76_15','pile_76_20','pile_76_25','pile_76_30','pile_89_15','pile_89_20','pile_89_25','pile_89_30','cap_76','cap_89','lag_40x20_6m'] },
    { name: '–ö—Ä–µ–ø—ë–∂', codes: ['clamp','bracket','screw_55x19'] },
    { name: '–í–æ—Ä–æ—Ç–∞ –æ—Ç–∫–∞—Ç–Ω—ã–µ', codes: Object.keys(PRICES.materials).filter(k => k.startsWith('gate_sliding') || k === 'foundation_sliding') },
    { name: '–í–æ—Ä–æ—Ç–∞ —Ä–∞—Å–ø–∞—à–Ω—ã–µ', codes: Object.keys(PRICES.materials).filter(k => k.startsWith('gate_swing') && !k.includes('gitter')) },
    { name: '–í–æ—Ä–æ—Ç–∞ –ì–∏—Ç—Ç–µ—Ä', codes: Object.keys(PRICES.materials).filter(k => k.includes('gate_gitter')) },
    { name: '–ö–∞–ª–∏—Ç–∫–∏', codes: ['wicket_standard','wicket_gitter','wicket_builtin','lock_mortise'] },
    { name: '–ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞', codes: ['came_bx608','gear_rack','remote','photo_sensor','wires_gofra','lamp_signal','antenna'] },
    { name: '–ü–ò–ö–°', codes: Object.keys(PRICES.materials).filter(k => k.startsWith('piks')) },
    { name: '–ü—Ä–æ—á–µ–µ', codes: ['gravel_bag','cps_bag','paint_touch','consumables','excavator'] }
  ];
  
  const workCats = [
    { name: '–†–∞–±–æ—Ç—ã - —É—Å—Ç–∞–Ω–æ–≤–∫–∞', codes: ['work_drilling','work_butovanie','work_pile_install','work_cap_weld','work_post_weld','work_cps_fill'] },
    { name: '–†–∞–±–æ—Ç—ã - –º–æ–Ω—Ç–∞–∂', codes: ['work_lag_weld','work_weld_paint','work_gitter_install','work_proflist_install','work_shtaketnik_install','work_strip_install'] },
    { name: '–†–∞–±–æ—Ç—ã - –≤–æ—Ä–æ—Ç–∞', codes: ['work_gate_sliding','work_gate_fill','work_swing_leaf','work_swing_fill','work_swing_hardware','work_swing_paint'] },
    { name: '–†–∞–±–æ—Ç—ã - –∫–∞–ª–∏—Ç–∫–∏', codes: ['work_wicket_mount','work_wicket_fill','work_wicket_hardware','work_wicket_lock','work_wicket_paint','work_wicket_builtin'] },
    { name: '–†–∞–±–æ—Ç—ã - –ø—Ä–æ—á–µ–µ', codes: ['work_automation','work_piks_full','work_piks_half','work_demontage','work_delivery','work_transport'] }
  ];
  
  const html = `
    <div class="card"><div class="card-title">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</div>
    ${cats.map((c, ci) => `
      <div class="price-cat">
        <div class="price-cat-header" onclick="togglePriceCat(${ci})">${c.name}</div>
        <div class="price-items" id="price-cat-${ci}">
          ${c.codes.map(code => {
            const p = PRICES.materials[code];
            if (!p) return '';
            return `<div class="price-item"><span>${p.name}</span><input type="number" class="price-input" value="${p.buy}" onchange="updatePrice('materials','${code}','buy',this.value)"><input type="number" class="price-input" value="${p.sell}" onchange="updatePrice('materials','${code}','sell',this.value)"></div>`;
          }).join('')}
        </div>
      </div>
    `).join('')}
    </div>
    
    <div class="card"><div class="card-title">–†–∞–±–æ—Ç—ã (–±—Ä–∏–≥–∞–¥–∞ / –∫–ª–∏–µ–Ω—Ç)</div>
    ${workCats.map((c, ci) => `
      <div class="price-cat">
        <div class="price-cat-header" onclick="togglePriceCat(${100 + ci})">${c.name}</div>
        <div class="price-items" id="price-cat-${100 + ci}">
          ${c.codes.map(code => {
            const p = PRICES.works[code];
            if (!p) return '';
            return `<div class="price-item"><span>${p.name}</span><input type="number" class="price-input" value="${p.crew || 0}" onchange="updatePrice('works','${code}','crew',this.value)"><input type="number" class="price-input" value="${p.sell}" onchange="updatePrice('works','${code}','sell',this.value)"></div>`;
          }).join('')}
        </div>
      </div>
    `).join('')}
    </div>
  `;
  document.getElementById('prices-container').innerHTML = html;
}

function togglePriceCat(idx) {
  document.getElementById('price-cat-' + idx).classList.toggle('open');
}

function updatePrice(type, code, field, val) {
  PRICES[type][code][field] = parseFloat(val) || 0;
  savePrices();
}

function exportPricesFile() {
  const blob = new Blob([JSON.stringify(PRICES, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'fence_prices_' + new Date().toISOString().slice(0, 10) + '.json';
  a.click();
  showToast('–¶–µ–Ω—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
}

function importPricesFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      PRICES = JSON.parse(e.target.result);
      savePrices();
      renderPrices();
      showToast('–¶–µ–Ω—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
    } catch (err) {
      showToast('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞', 'error');
    }
  };
  reader.readAsText(file);
}

function resetAllPrices() {
  if (confirm('–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ü–µ–Ω—ã –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) {
    PRICES = JSON.parse(JSON.stringify(DEFAULT_PRICES));
    savePrices();
    renderPrices();
    showToast('–¶–µ–Ω—ã —Å–±—Ä–æ—à–µ–Ω—ã');
  }
}
</script>
</body>
</html>
